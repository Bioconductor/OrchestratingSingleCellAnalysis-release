# 416B Smart-seq2 dataset



## Introduction

This performs an analysis of the @lun2018assessing Smart-seq2 dataset, 
which contains two 96-well plates of 416B cells with and without induction of a _CBFB-MYH11_ oncogene.

## Analysis code

### Data loading


```r
library(scRNAseq)
sce.416b <- LunSpikeInData(which="416b") 
```

### Gene annotation


```r
library(AnnotationHub)
ens.mm.v97 <- AnnotationHub()[["AH73905"]]
rowData(sce.416b)$ENSEMBL <- rownames(sce.416b)
rowData(sce.416b)$SYMBOL <- mapIds(ens.mm.v97, keys=rownames(sce.416b),
    keytype="GENEID", column="SYMBOL")
rowData(sce.416b)$SEQNAME <- mapIds(ens.mm.v97, keys=rownames(sce.416b),
    keytype="GENEID", column="SEQNAME")

library(scater)
rownames(sce.416b) <- uniquifyFeatureNames(rowData(sce.416b)$ENSEMBL, 
    rowData(sce.416b)$SYMBOL)
```

### Quality control

We save an unfiltered copy of the `SingleCellExperiment` for later use.


```r
unfiltered <- sce.416b
```


```r
mito <- which(rowData(sce.416b)$SEQNAME=="MT")
stats <- perCellQCMetrics(sce.416b, subsets=list(Mt=mito))
qc <- quickCellQC(stats, percent_subsets="subsets_Mt_percent")
sce.416b <- sce.416b[,!qc$discard]
```

### Normalization

No pre-clustering is performed here, as the dataset is small and the cells are all similar.


```r
library(scran)
sce.416b <- computeSumFactors(sce.416b)
sce.416b <- logNormCounts(sce.416b)
```

### Variance modelling

We take all of the genes with positive biological components.


```r
dec.416b <- modelGeneVarWithSpikes(sce.416b, "ERCC")
chosen.hvgs <- rownames(dec.416b)[dec.416b$bio > 0]
```

### Batch correction

The composition of cells is expected to be the same across the two plates, 
hence the use of `removeBatchEffect()` rather than more complex methods.


```r
library(limma)
assay(sce.416b, "corrected") <- removeBatchEffect(logcounts(sce.416b), 
    design=model.matrix(~sce.416b$phenotype), batch=sce.416b$block)
```

### Dimensionality reduction


```r
sce.416b <- denoisePCA(sce.416b, technical=dec.416b, 
    subset.row=chosen.hvgs, assay.type="corrected")

set.seed(1010)
sce.416b <- runTSNE(sce.416b, use_dimred="PCA", perplexity=10)
```

### Clustering


```r
my.dist <- dist(reducedDim(sce.416b, "PCA"))
my.tree <- hclust(my.dist, method="ward.D2")

library(dynamicTreeCut)
my.clusters <- unname(cutreeDynamic(my.tree, distM=as.matrix(my.dist),
    minClusterSize=10, verbose=0))
sce.416b$cluster <- factor(my.clusters)
```

## Results

### Quality control statistics


```r
par(mfrow=c(1,2))
plot(stats$sum, stats$detected, xlab="Library size",
    ylab="Number of detected genes", log="xy")     
plot(stats$sum, stats$subsets_Mt_percent, xlab="Library size",
    ylab="Number of detected genes", log="x")
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-3-1.svg" width="672" />

```r
par(mfrow=c(1,2))
boxplot(split(log10(stats$sum), unfiltered$block), ylab="Log10 library size")
boxplot(split(log10(stats$detected), unfiltered$block), ylab="Log10 number of genes")
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-3-2.svg" width="672" />

```r
par(mfrow=c(1,2))
boxplot(split(log10(stats$sum), unfiltered$phenotype), ylab="Log10 library size")
boxplot(split(log10(stats$detected), unfiltered$phenotype), ylab="Log10 number of genes")
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-3-3.svg" width="672" />


```r
colSums(as.matrix(qc))
```

```
##            low_lib_size          low_n_features high_subsets_Mt_percent 
##                       4                       0                       1 
##                 discard 
##                       5
```

### Normalization


```r
summary(sizeFactors(sce.416b))
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    0.26    0.70    0.93    1.00    1.14    3.61
```


```r
plot(librarySizeFactors(sce.416b), sizeFactors(sce.416b), pch=16,
    xlab="Library size factors", ylab="Deconvolution factors", log="xy")     
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-6-1.svg" width="672" />

### Variance modelling


```r
plot(dec.416b$mean, dec.416b$total, col="black", pch=16,
    xlab="Mean log-expression", ylab="Variance of log-expression")     
fit.416b <- metadata(dec.416b)
points(fit.416b$mean, fit.416b$var, col="red", pch=16)
curve(fit.416b$trend(x), add=TRUE, col="dodgerblue")
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-7-1.svg" width="672" />

### Clustering

We compare the clusters to the plate of origin.


```r
table(Cluster=sce.416b$cluster, Plate=sce.416b$block)
```

```
##        Plate
## Cluster 20160113 20160325
##       1       48       42
##       2       23       23
##       3       19       19
##       4        5        8
```

We compare the clusters to the oncogene induction status.


```r
table(Cluster=sce.416b$cluster, Oncogene=sce.416b$phenotype)
```

```
##        Oncogene
## Cluster induced CBFB-MYH11 oncogene expression wild type phenotype
##       1                                     81                   9
##       2                                      0                  46
##       3                                      0                  38
##       4                                     13                   0
```


```r
plotTSNE(sce.416b, colour_by="cluster")
```

<img src="P3_W02.lun-416b_files/figure-html/unnamed-chunk-10-1.svg" width="672" />

## References
